#!/bin/bash
# Quick issue status report

set -e

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Read issue data using git plumbing (not git notes API)
# Accepts a full ref path like refs/notes/issue-abc123
read_issue_data_by_ref() {
    local ref="$1"
    local tree_hash
    tree_hash=$(git cat-file -p "$ref" 2>/dev/null | grep "^tree" | cut -d' ' -f2) || return 1
    local blob_hash
    blob_hash=$(git ls-tree "$tree_hash" 2>/dev/null | awk '$4 == "issue" {print $3}')
    if [[ -z "$blob_hash" ]]; then
        blob_hash=$(git ls-tree "$tree_hash" 2>/dev/null | tail -1 | awk '{print $3}')
    fi
    [[ -z "$blob_hash" ]] && return 1
    git cat-file -p "$blob_hash" 2>/dev/null || return 1
}

echo -e "${BLUE}Issue Status Report${NC}"
echo -e "Generated: $(date)"
echo ""

# Count issues by status
open_count=0
in_progress_count=0
closed_count=0
blocked_count=0

# Count by priority
high_count=0
medium_count=0
low_count=0

# Process each issue
for ref in $(git for-each-ref --format="%(refname)" refs/notes/issue-* 2>/dev/null | sort); do
    if data=$(read_issue_data_by_ref "$ref" 2>/dev/null); then
        status_val=$(echo "$data" | grep -E "^(status|state):" | head -1 | cut -d' ' -f2)
        priority=$(echo "$data" | grep "^priority:" | cut -d' ' -f2)

        case "$status_val" in
            open) open_count=$((open_count + 1)) ;;
            in_progress|in-progress) in_progress_count=$((in_progress_count + 1)) ;;
            closed|done) closed_count=$((closed_count + 1)) ;;
            blocked) blocked_count=$((blocked_count + 1)) ;;
        esac

        case "$priority" in
            high|critical) high_count=$((high_count + 1)) ;;
            medium) medium_count=$((medium_count + 1)) ;;
            low) low_count=$((low_count + 1)) ;;
        esac
    fi
done

total=$((open_count + in_progress_count + closed_count + blocked_count))

echo -e "${YELLOW}Summary:${NC}"
echo "Total Issues: $total"
echo ""

echo -e "${YELLOW}By Status:${NC}"
echo "  Open: $open_count"
echo "  In Progress: $in_progress_count"
echo "  Closed: $closed_count"
echo "  Blocked: $blocked_count"
echo ""

echo -e "${YELLOW}By Priority:${NC}"
echo "  High/Critical: $high_count"
echo "  Medium: $medium_count"
echo "  Low: $low_count"
echo ""

echo -e "${YELLOW}Open Issues by Priority:${NC}"
"$(dirname "$0")/git-issue" list | grep -E "\[open\]" | sort -t: -k2 -r
